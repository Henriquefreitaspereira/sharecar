<!DOCTYPE html>
<html>
   <head>
      <title>ShareCar</title>
      <link href="css/jquery-ui-1.9.2.custom.css" rel="stylesheet" media="screen" />
      <link href="css/main.css" rel="stylesheet" media="screen" />
      <script src="https://maps.googleapis.com/maps/api/js?sensor=false&amp;libraries=geometry,places" type="text/javascript"></script>
      <script src="js/jquery-1.9.1.min.js" type="text/javascript"></script>
      <script src="js/jquery-ui-1.9.2.custom.js" type="text/javascript"></script>
      <script src="js/globalize.js" type="text/javascript"></script>
      <script src="js/globalize-de.js" type="text/javascript"></script>
      <script src="js/main.js" type="text/javascript"></script>
      <script>
      $(function () {

    	  loadMapCenteredWithUserGeolocation();

    	  loadRoutesTable();
    	  
    	  $("#accordion").accordion({
    	    heightStyle: "fill",
    	    active: 1
    	  });
    	  
    	  $("#slider").slider({
    	    value: 100,
    	    min: 50,
    	    max: 1000,
    	    step: 50,
    	    slide: function (event, ui) {
    	      $("#radius").val(ui.value);
    	      circlesArray[0].setRadius(ui.value);
    	    }
    	  });
    	  
    	  $("#radius").val($("#slider").slider("value"));

    	  $("#radio").buttonset();

    	  $("#bt-pesquisar").button().click(function(){
    		  $('#table-pesquisa tbody > tr').remove();
					var lat = markersArray[0].position.Ya;
    	  	var lng = markersArray[0].position.Za;
					var radius = $("#radius").val();

		    	$.ajax({
    				url : "http://localhost:8080/sharecar/api/route/" + lat + "/" + lng + "/" + radius,
    				success : function(data) {
    					 $.each(data,
    					        function (key, val) {
    					                var tr = '';
    					                tr += '<tr>';
    					                tr += '<td width="24px">';
    					                tr += '<a href="#" name="route-' + val.id + '" route="' + val.id + '">';
    					                tr += '<img src="img/map.png" style="height: 24px; width: 24px;" border="0" title="Ver rota no mapa">';
    					                tr += '</a>';
    					                tr += '</td>';
    					                tr += '<td>' + val.description + '</td>';
    					                tr += '</tr>';
    					                $("#table-pesquisa > tbody:last").append(tr);
    					            });
    				},
    				dataType : 'json'
    			});
				});
    	  
    	  $.widget("ui.timespinner", $.ui.spinner, {
    	    options: {
    	      // 30 minutos
    	      step: 1800 * 1000,
    	      // 1 hora
    	      page: 60
    	    },
    	    
    	    _parse: function (value) {
    	      if (typeof value === "string") {
    	        // already a timestamp
    	        if (Number(value) == value) {
    	          return Number(value);
    	        }
    	        return +Globalize.parseDate(value);
    	      }
    	      return value;
    	    },
    	    
    	    _format: function (value) {
    	      return Globalize.format(new Date(value), "t");
    	    }
    	  });
    	  Globalize.culture("de-DE");
    	  $("#hora-ini, #hora-fim").timespinner();

    		//Gatilhos
    		
    		// Ao clicar no mapa é adicionado um marcador
    	  google.maps.event.addListener(map, 'click', function(event) {
    	  	addMarker(event.latLng, $("#radius").val());
    	  });
    	  
    	  // Mostra a rota no mapa após clicar no ícone da tabela de rotas
    	  $("#table-rotas, #table-pesquisa").delegate("a[name^='route-']", "click", function () {
    		  loadRoute($(this).attr("route"))
    	  });
    	  
    	  // Alterando o ponto de chegada a rota é renderizada
    	  var ptoPartida = new google.maps.places.Autocomplete($("#start")[0]);
    	  var ptoChegada = new google.maps.places.Autocomplete($("#end")[0]);
    	  google.maps.event.addListener(ptoChegada, 'place_changed', function () {
    		  showRouteBetweenPoints($("#start").val(), $("#end").val());
    	  });
    	  
    	  // Salva a rota
    	  // TODO: Ajustar para quando o usuário alterar a rota
    	  // TODO: Verificar campos obrigatórios
    	  $("#btSalvar").click(function () {
					saveRoute($("#route-name").val(), $("#start").val(), $("#end").val());
				});
          
    	});
      </script>
   </head>
   <body>
      <div id="formulario">
         <div id="accordion">
            <h3>Criar Rota</h3>
            <div>
               <label for="route-name">Nome:</label><br /> 
               <input id="route-name" style="width: 100%" value="" required/><br /> 
               <label for="start">Ponto de Partida:</label><br /> 
               <input id="start" style="width: 100%" value=""  required /><br /> 
               <label for="end">Ponto de Chegada:</label><br /> 
               <input id="end" style="width: 100%" value="" required /><br />
               <input type="button" id="btSalvar" value="Salvar" />

               <!--p>
                  <label for="radio">Dia da Semana</label><br/>
               		<div id="radio">
                  	<input type="radio" id="radio1" name="radio" /><label for="radio1" style="font-size:10pt; width:50px;">Dom</label>
                  	<input type="radio" id="radio2" name="radio" /><label for="radio2" style="font-size:10pt; width:50px;">Seg</label>
                  	<input type="radio" id="radio3" name="radio" /><label for="radio3" style="font-size:10pt; width:50px;">Ter</label>
                  	<input type="radio" id="radio4" name="radio" /><label for="radio4" style="font-size:10pt; width:50px;">Qua</label>
                  	<input type="radio" id="radio5" name="radio" /><label for="radio5" style="font-size:10pt; width:50px;">Qui</label>
                  	<input type="radio" id="radio6" name="radio" /><label for="radio6" style="font-size:10pt; width:50px;">Sex</label>
                  	<input type="radio" id="radio7" name="radio" /><label for="radio7" style="font-size:10pt; width:50px;">Sáb</label>
               		</div>
               </p>
               
               <p>
                  <label>Horário</label><br/>	
                  <input id="hour" name="hour" value="08:00" style="width: 60px" readonly />
               </p-->
               
               <br /><br />
               <table id="table-rotas" class="table table-bordered">
                  <thead>
                     <tr>
                        <th class="ui-widget-header" colspan="2">Minhas Rotas</th>
                     </tr>
                  </thead>
                  <tbody></tbody>
               </table>
            </div>
            <h3>Buscar Carona</h3>
            <div>
               <p>
                  <label for="endereco">Marque no mapa sua localização</label>
                  <textarea id="endereco" style="width:390px; height: 50px; font-size: 10pt" readonly></textarea>
               </p>
               
               <p>
                  <label for="raio">Raio</label>
                  <input type="text" id="radius" name="radius" style="width: 55px; border: 0; color: #f6931f; font-weight: bold; text-align:center" readonly /> metros
               </p>
               <div id="slider"></div>
               
               <p>
                  <label for="radio">Dia da Semana</label><br/>
               		<div id="radio">
                  	<input type="radio" id="radio1" name="radio" /><label for="radio1" style="font-size:10pt; width:50px;">Dom</label>
                  	<input type="radio" id="radio2" name="radio" /><label for="radio2" style="font-size:10pt; width:50px;">Seg</label>
                  	<input type="radio" id="radio3" name="radio" /><label for="radio3" style="font-size:10pt; width:50px;">Ter</label>
                  	<input type="radio" id="radio4" name="radio" /><label for="radio4" style="font-size:10pt; width:50px;">Qua</label>
                  	<input type="radio" id="radio5" name="radio" /><label for="radio5" style="font-size:10pt; width:50px;">Qui</label>
                  	<input type="radio" id="radio6" name="radio" /><label for="radio6" style="font-size:10pt; width:50px;">Sex</label>
                  	<input type="radio" id="radio7" name="radio" /><label for="radio7" style="font-size:10pt; width:50px;">Sáb</label>
               		</div>
               </p>
               
               <p>
                  <label>Intervalo de Horário</label><br/>	
                  <input id="hora-ini" name="hora-ini" value="08:00" style="width: 60px" readonly /> e <input id="hora-fim" name="hora-fim" value="09:00" style="width: 60px" readonly />
               </p>
               
               <input id="bt-pesquisar" type="button" value="Pesquisar" />
               <br/><br/>
               <table id="table-pesquisa" class="table table-bordered">
                  <thead>
                     <tr>
                        <th class="ui-widget-header" colspan="2">Rotas Encontradas</th>
                     </tr>
                  </thead>
                  <tbody></tbody>
               </table>
            </div>
         </div>
      </div>
      <div id="mapa"></div>
   </body>
</html>
